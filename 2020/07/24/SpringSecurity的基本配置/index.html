<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"litterbitchfeng.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="&amp;nbsp;&amp;nbsp;SpringBoot针对SpringSecurity提供了自动化配置方案,因此可以使SpringSecurity非常容易整合进行SpringBoot项目中,这也是在SpringBoot项目中使用SpringSecurity的优势.">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringSecurity的基本配置">
<meta property="og:url" content="https://litterbitchfeng.github.io/2020/07/24/SpringSecurity%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="键人冯小笔记">
<meta property="og:description" content="&amp;nbsp;&amp;nbsp;SpringBoot针对SpringSecurity提供了自动化配置方案,因此可以使SpringSecurity非常容易整合进行SpringBoot项目中,这也是在SpringBoot项目中使用SpringSecurity的优势.">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-07-24T06:31:27.000Z">
<meta property="article:modified_time" content="2020-07-30T09:28:50.901Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="安全">
<meta property="article:tag" content="加密">
<meta property="article:tag" content="登录">
<meta property="article:tag" content="注销">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://litterbitchfeng.github.io/2020/07/24/SpringSecurity%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>SpringSecurity的基本配置 | 键人冯小笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">

  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">键人冯小笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">爬</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://litterbitchfeng.github.io/2020/07/24/SpringSecurity%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="平时小笔记，记录别人美好代码">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="键人冯小笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          SpringSecurity的基本配置
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-24 14:31:27" itemprop="dateCreated datePublished" datetime="2020-07-24T14:31:27+08:00">2020-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-30 17:28:50" itemprop="dateModified" datetime="2020-07-30T17:28:50+08:00">2020-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>&nbsp;&nbsp;SpringBoot针对SpringSecurity提供了自动化配置方案,因此可以使SpringSecurity非常容易整合进行SpringBoot项目中,这也是在SpringBoot项目中使用SpringSecurity的优势.</p>
<a id="more"></a>
<h1 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h1><p>1.创建项目,添加依赖<br>&nbsp;&nbsp;创建一个SpringBootWeb项目,然后添加spring-boot-starter-security依赖即可,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2.添加hello接口<br>&nbsp;&nbsp;接下来在项目中添加一个简单的/hello接口,内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class HelloController &#123;</span><br><span class="line">    @GetMapping(&quot;&#x2F;hello&quot;)</span><br><span class="line">    public String hello()&#123;</span><br><span class="line">        return &quot;Hello&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.启动项目测试<br>&nbsp;&nbsp;接下来启动项目,启动成功,访问/hello接口会自动跳转到登录页面,这个登录页面是由SpringSecurity提供的,默认的用户名是user,默认的登录密码则在每次启动项目时随机生成,查看项目启动日志.    </p>
<h1 id="配置用户名和密码"><a href="#配置用户名和密码" class="headerlink" title="配置用户名和密码"></a>配置用户名和密码</h1><p>&nbsp;&nbsp;如果您对默认的用户名和密码不满意,可以在application.yml或application.properties中配置默认的用户名、密码以及用户角色,下面是.yml中的配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  security:</span><br><span class="line">    user:</span><br><span class="line">      name: sang</span><br><span class="line">      password: 123</span><br><span class="line">      roles: admin</span><br></pre></td></tr></table></figure>
<h1 id="基于内存的认证"><a href="#基于内存的认证" class="headerlink" title="基于内存的认证"></a>基于内存的认证</h1><p>&nbsp;&nbsp;当然,开发者也可以自定义类继承自WebSecurityConfigurerAdapter,进而实现对SpringSecurity更多的自定义配置,例如基于内存的认证,配置方式如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class MyWebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return NoOpPasswordEncoder.getInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth)throws Exception&#123;</span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .withUser(&quot;admin&quot;).password(&quot;123&quot;).roles(&quot;ADMIN&quot;,&quot;USER&quot;)</span><br><span class="line">                .and()</span><br><span class="line">                .withUser(&quot;sang&quot;).password(&quot;123&quot;).roles(&quot;USER&quot;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>•本案例使用的SpringSecurity版本是5.0.6,在SpringSecurity5.x中引入了多种密码加密方式,开发者必须指定一种,本案例NoOpPasswordEncoder,即不对密码进行加密.</p>
<h1 id="HttpSecurity"><a href="#HttpSecurity" class="headerlink" title="HttpSecurity"></a>HttpSecurity</h1><p>&nbsp;&nbsp;虽然现在可以实现认证功能,但是受保护的资源都是默认的,而且也不能根据实际情况进行角色管理，如果要实现这些功能,就需要重写 WebSecurityConfigurerAdapter中的另一个方法,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class MyWebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return NoOpPasswordEncoder.getInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth)throws Exception&#123;</span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .withUser(&quot;admin&quot;).password(&quot;123&quot;).roles(&quot;ADMIN&quot;,&quot;USER&quot;)</span><br><span class="line">                .and()</span><br><span class="line">                .withUser(&quot;sang&quot;).password(&quot;123&quot;).roles(&quot;USER&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    protected void configure(HttpSecurity http)throws Exception&#123;</span><br><span class="line">        http.authorizeRequests()&#x2F;&#x2F;调用authorizeRequests()方法开启HttpSecurity的配置</span><br><span class="line">                .antMatchers(&quot;&#x2F;admin&#x2F;**&quot;)&#x2F;&#x2F;表示用户访问&quot;&#x2F;admin&#x2F;**&quot;模式的URL必须具备ADMIN的角色;</span><br><span class="line">                .hasRole(&quot;ADMIN&quot;)</span><br><span class="line">                .antMatchers(&quot;&#x2F;user&#x2F;**&quot;)&#x2F;&#x2F;表示用户访问&quot;&#x2F;user&#x2F;**&quot;模式的URL必须具备ADMIN或USER的角色;</span><br><span class="line">                .access(&quot;hasAnyRole(&#39;ADMIN&#39;,&#39;USER&#39;)&quot;)</span><br><span class="line">                .antMatchers(&quot;&#x2F;db&#x2F;**&quot;)&#x2F;&#x2F;表示用户访问&quot;&#x2F;user&#x2F;**&quot;模式的URL必须具备ADMIN或DBA的角色;</span><br><span class="line">                .access(&quot;hasRole(&#39;ADMIN&#39;) and hasRole(&#39;DBA&#39;)&quot;)</span><br><span class="line">                .anyRequest()</span><br><span class="line">                .authenticated()&#x2F;&#x2F;表示除了前面定义的URL模式之外,用户访问其他的URL都必须认证后访问</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">	.loginProcessingUrl(&quot;&#x2F;login&quot;)&#x2F;&#x2F;表示开启表单登录,即刚才刚刚访问的hello地址弹出的登录页面,可以直接调用&quot;&#x2F;login&quot;接口.</span><br><span class="line">	.permitAll()</span><br><span class="line">	.and()</span><br><span class="line">	.csrf()</span><br><span class="line">	.diable();&#x2F;&#x2F;表示关闭csrf</span><br></pre></td></tr></table></figure>
<h1 id="登录表单详细配置"><a href="#登录表单详细配置" class="headerlink" title="登录表单详细配置"></a>登录表单详细配置</h1><p>&nbsp;&nbsp;迄今为止，登录表单一直使用SpringSecurity 提供的页面,登录成功后也是默认的页面跳转, 但是,前后端分离正在成为企业级应用开发的主流,在前后端分离的开发方式中,前后端的数据交互通过JSON进行,这时,登录成功后就不是页面跳转了,而是一段JSON提示.要实现这些功能,只需要继续完善上文的配置,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">.and()</span><br><span class="line">               .formLogin()</span><br><span class="line">               .loginPage(&quot;&#x2F;logindo&quot;)&#x2F;&#x2F;配置了loginPage,即登录页面,配置了loginPage后,如果用户未授权就访问一个需要授权</span><br><span class="line">					才能访问的接口,就会自动跳转到logindo页面让用户登录,这个logindo就是</span><br><span class="line">					开发者自定义的登录页面,而不是SpringSecurity提供的默认登录页.</span><br><span class="line">               .loginProcessingUrl(&quot;&#x2F;login&quot;)&#x2F;&#x2F;表示登录请求处理接口,无论是自定义登录页面还是移动端登录,都需要使用该接口.</span><br><span class="line">               .usernameParameter(&quot;username&quot;)&#x2F;&#x2F;用户名 页面表单的name值为username,根据实际情况改变</span><br><span class="line">               .passwordParameter(&quot;password&quot;)&#x2F;&#x2F;密码 页面表单的name值为password,同上</span><br><span class="line">               .successHandler(new AuthenticationSuccessHandler() &#123;&#x2F;&#x2F;登录成功后的处理</span><br><span class="line">                   @Override</span><br><span class="line">                   public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication auth) throws IOException, ServletException &#123;</span><br><span class="line">                       Object principal &#x3D;  auth.getPrincipal();</span><br><span class="line">                       response.setContentType(&quot;application&#x2F;json;charset&#x3D;utf-8&quot;);</span><br><span class="line">                       PrintWriter out &#x3D; response.getWriter();</span><br><span class="line">                       response.setStatus(200);</span><br><span class="line">                       Map&lt;String,Object&gt; map &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">                       map.put(&quot;status&quot;,200);</span><br><span class="line">                       map.put(&quot;msg&quot;,principal);</span><br><span class="line">                       ObjectMapper om &#x3D; new ObjectMapper();</span><br><span class="line">                       out.write(om.writeValueAsString(map));</span><br><span class="line">                       out.flush();</span><br><span class="line">                       out.close();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;)</span><br><span class="line">               .failureHandler(new AuthenticationFailureHandler() &#123;登录失败后的处理</span><br><span class="line">                   @Override</span><br><span class="line">                   public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException &#123;</span><br><span class="line">                       response.setContentType(&quot;application&#x2F;json;charset&#x3D;utf-8&quot;);</span><br><span class="line">                       PrintWriter out &#x3D;  response.getWriter();</span><br><span class="line">                       response.setStatus(401);</span><br><span class="line">                       Map&lt;String,Object&gt; map &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">                       map.put(&quot;status&quot;,401);</span><br><span class="line">                       if(e instanceof LockedException)&#123;</span><br><span class="line">                           map.put(&quot;msg&quot;,&quot;账户被锁定，登录失败!&quot;);</span><br><span class="line">                       &#125;else if(e instanceof BadCredentialsException)&#123;</span><br><span class="line">                           map.put(&quot;msg&quot;,&quot;账户名或密码输入错误，登录失败!&quot;);</span><br><span class="line">                       &#125;else if(e instanceof DisabledException)&#123;</span><br><span class="line">                           map.put(&quot;msg&quot;,&quot;账户被禁用，登录失败!&quot;);</span><br><span class="line">                       &#125;else if(e instanceof AccountExpiredException)&#123;</span><br><span class="line">                           map.put(&quot;msg&quot;,&quot;账户已过期，登录失败!&quot;);</span><br><span class="line">                       &#125;else if(e instanceof CredentialsExpiredException)&#123;</span><br><span class="line">                           map.put(&quot;msg&quot;,&quot;密码已过期，登录失败!&quot;);</span><br><span class="line">                       &#125;else&#123;</span><br><span class="line">                           map.put(&quot;msg&quot;,&quot;登录失败!&quot;);</span><br><span class="line">                       &#125;</span><br><span class="line">                       ObjectMapper om &#x3D; new ObjectMapper();</span><br><span class="line">                       out.write(om.writeValueAsString(map));</span><br><span class="line">                       out.flush();</span><br><span class="line">                       out.close();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;)</span><br><span class="line">               .permitAll()</span><br><span class="line">               .and()</span><br></pre></td></tr></table></figure>
<h1 id="注销登录配置"><a href="#注销登录配置" class="headerlink" title="注销登录配置"></a>注销登录配置</h1><p>&nbsp;&nbsp;如果想要注销登录,也只需要提供简单的配置即可,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.and()&#x2F;&#x2F;承接上文 .permitAll()</span><br><span class="line">.logout()&#x2F;&#x2F;表示开启注销登录的配置.</span><br><span class="line">.logoutUrl(&quot;&#x2F;logout&quot;)&#x2F;&#x2F;表示配置注销登录请求URL为&quot;&#x2F;logout&quot;,默认也是&quot;&#x2F;logout&quot;</span><br><span class="line">.clearAuthentication(true)&#x2F;&#x2F;表示是否清除身份认证信息,默认为true,表示清除.</span><br><span class="line">.invalidateHttpSession(true)&#x2F;&#x2F;表示是否使Session失效,默认为true.</span><br><span class="line">.addLogoutHandler(new LogoutHandler() &#123;&#x2F;&#x2F;配置一个LogutHandler,开发者可以在LogoutHandler中完成一些数据清除工作,例如Cookie的清除.</span><br><span class="line">    @Override</span><br><span class="line">    public void logout(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.logoutSuccessHandler(new LogoutSuccessHandler() &#123;&#x2F;&#x2F;配置一个LogoutSuccessHandler,可以在这里处理注销成功后的业务逻辑,例如返回一段JSON提示或者跳转到登录页面等.</span><br><span class="line">    @Override</span><br><span class="line">    public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException &#123;</span><br><span class="line">        response.sendRedirect(&quot;boot2&#x2F;logindo&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">.and()</span><br><span class="line">.csrf()</span><br><span class="line">.disable();</span><br></pre></td></tr></table></figure>
<h1 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h1><p>&amp;nbsp:&nbsp;在SpringBoot中配置密码加密非常容易,只需修改上文配置的PasswordEncoder这个Bean的实现即可,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">	return new BCryptPasswordEncoder(10);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;创建BCryptPasswordEncoder时传入的参数10就是strength,即密钥的迭代次数(也可以不配置,默认为10).同时,配置的内存用户的密码也不再时123了,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auth.inMemoryAuthentication()</span><br><span class="line">               .withUser(&quot;admin&quot;).password(&quot;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&quot;).roles(&quot;ADMIN&quot;,&quot;USER&quot;)</span><br><span class="line">               .and()</span><br><span class="line">               .withUser(&quot;sang&quot;).password(&quot;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&quot;).roles(&quot;USER&quot;);</span><br></pre></td></tr></table></figure>

<h1 id="基于数据库的认证"><a href="#基于数据库的认证" class="headerlink" title="基于数据库的认证"></a>基于数据库的认证</h1><p>&nbsp;&nbsp;上文向读者介绍的认证数据都是定义在内存中的,在真实项目中,用户的基本信息以及角色 等都存储在数据库中,因此需要从数据库中获取数据进行认证.本节将向读者介绍如何使用数据库中的数据进行认证和授权.<br>1.设计数据表<br>&nbsp;&nbsp;首先需要设计一个基本的用户角色表,一共三张表,分别是用户表、角色表、以及用户角色关联表.为了方便测试,预置几条测试数据,如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user(用户表):主键 id int(11),username varchar(32),password varchar(255),enabled tinyint(1),locked tinyint(1)</span><br><span class="line">role(角色表):主键 id int(11),name varchar(32),nameZh varchar(32)</span><br><span class="line">user_role(用户角色关联表):主键 id int(11),uid int(11),rid int(11)</span><br><span class="line"></span><br><span class="line">角色名有一个默认的前缀&quot;ROLE_&quot;.</span><br></pre></td></tr></table></figure>
<p>2.创建项目<br>&nbsp;&nbsp;MyBatis灵活,JPA便利,本案例选择前者,因此创建SpringBootWeb项目添加如下依赖:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-security&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line"> &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.mybatis.spring.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.1.0&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.1&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;druid&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.9&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>3.配置数据库<br>&nbsp;&nbsp;在application.properties或application.yml中进行数据库连接配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">      type: com.alibaba.druid.pool.DruidDataSource</span><br><span class="line">      driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">      url: jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;itrip?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;serverTimezone&#x3D;UTC&amp;useSSL&#x3D;true</span><br><span class="line">      username: root</span><br><span class="line">    password:</span><br></pre></td></tr></table></figure>
<p>4.创建实体类<br>&nbsp;&nbsp;分别创建角色表和用户表对应的实体类,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">@Data</span><br><span class="line">public class Role &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line">    private String name;</span><br><span class="line">    private String nameZh;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class User1 implements UserDetails &#123;</span><br><span class="line">    private Integer id;</span><br><span class="line">    private String username;</span><br><span class="line">    private String password;</span><br><span class="line">    private Boolean enabled;</span><br><span class="line">    private Boolean locked;</span><br><span class="line">    private List&lt;Role&gt; roles;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() &#123;</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities &#x3D; new ArrayList&lt;SimpleGrantedAuthority&gt;();</span><br><span class="line">        for (Role role : roles) &#123;</span><br><span class="line">            authorities.add(new SimpleGrantedAuthority(role.getName()));</span><br><span class="line">        &#125;</span><br><span class="line">        return authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String getPassword() &#123;return password;&#125;</span><br><span class="line">    @Override</span><br><span class="line">    public String getUsername() &#123;return username;&#125;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean isAccountNonExpired() &#123;return true;&#125;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean isAccountNonLocked() &#123;return !locked;&#125;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean isCredentialsNonExpired() &#123;return true;&#125;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean isEnabled() &#123;return enabled;&#125;</span><br><span class="line"></span><br><span class="line">    public Integer getId() &#123;return id;&#125;</span><br><span class="line"></span><br><span class="line">    public void setId(Integer id) &#123;this.id &#x3D; id;&#125;</span><br><span class="line"></span><br><span class="line">    public void setUsername(String username) &#123;this.username &#x3D; username;&#125;</span><br><span class="line"></span><br><span class="line">    public void setPassword(String password) &#123;this.password &#x3D; password;&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;    public Boolean isEnabled() &#123;</span><br><span class="line">&#x2F;&#x2F;        return enabled;</span><br><span class="line">&#x2F;&#x2F;    &#125;</span><br><span class="line">    public void setEnabled(Boolean enabled) &#123;this.enabled &#x3D; enabled;&#125;</span><br><span class="line">   public Boolean isLocked() &#123;&#x2F;&#x2F;boolean类型不能使用Get方法,故用isLocked()</span><br><span class="line">        return locked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setLocked(Boolean locked) &#123;this.locked &#x3D; locked;&#125;</span><br><span class="line">    public List&lt;Role&gt; getRoles() &#123;return roles;&#125;</span><br><span class="line">    public void setRoles(List&lt;Role&gt; roles) &#123;this.roles &#x3D; roles;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserDetails接口的7个方法:</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>getAuthorities();</td>
<td>获取当前用户对象所具有的角色信息</td>
</tr>
<tr>
<td>getPassword();</td>
<td>获取当前用户对象的密码</td>
</tr>
<tr>
<td>getUsername();</td>
<td>获取当前用户对象的用户名</td>
</tr>
<tr>
<td>isAccountNonExpired();</td>
<td>当前账户是否未过期</td>
</tr>
<tr>
<td>isAccountNonLocked();</td>
<td>当前账户是否未锁定</td>
</tr>
<tr>
<td>isCredentialsNonExpired();</td>
<td>当前账户密码是否未过期</td>
</tr>
<tr>
<td>isEnabled();</td>
<td>当前账户是否可用</td>
</tr>
</tbody></table>
<p>5.创建UserService<br>&nbsp;&nbsp;接下来创建UserService,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class UserService implements UserDetailsService &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</span><br><span class="line">        User1 user &#x3D; userMapper.loadUserByUsername(username);</span><br><span class="line">        if(user &#x3D;&#x3D; null)&#123;</span><br><span class="line">            throw new UsernameNotFoundException(&quot;账户不存在!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        user.setRoles(userMapper.getUserRolesByUid(user.getId()));</span><br><span class="line">        return user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;这里还涉及了UserMapper和UserMapper.xml,相关源码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Mapper</span><br><span class="line">public interface UserMapper &#123;</span><br><span class="line">    User1 loadUserByUsername(@Param(value &#x3D; &quot;username&quot;) String username);</span><br><span class="line">    List&lt;Role&gt; getUserRolesByUid(@Param(value &#x3D; &quot;id&quot;)Integer id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Mapper 3.0&#x2F;&#x2F;EN&quot;</span><br><span class="line">        &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace&#x3D;&quot;cn.pro.mapper.UserMapper&quot;&gt;</span><br><span class="line">    &lt;select id&#x3D;&quot;loadUserByUsername&quot; resultType&#x3D;&quot;User1&quot;&gt;</span><br><span class="line">        select * from user where username&#x3D;#&#123;username&#125;</span><br><span class="line">    &lt;&#x2F;select&gt;</span><br><span class="line">    &lt;select id&#x3D;&quot;getUserRolesByUid&quot; resultType&#x3D;&quot;Role&quot;&gt;</span><br><span class="line">        select * from role r,user_role ur where r.id&#x3D;ur.rid and ur.uid&#x3D;#&#123;id&#125;</span><br><span class="line">    &lt;&#x2F;select&gt;</span><br><span class="line">&lt;&#x2F;mapper&gt;</span><br></pre></td></tr></table></figure>
<p>6.配置SpringSecurity<br>&nbsp;&nbsp;接下来对SpringSecurity进行配置,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class MyWebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    UserService userService;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return new BCryptPasswordEncoder(10);</span><br><span class="line">    &#125;</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth)throws Exception&#123;</span><br><span class="line">        auth.userDetailsService(userService);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http)throws Exception&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(&quot;&#x2F;admin&#x2F;**&quot;).hasRole(&quot;admin&quot;)</span><br><span class="line">	.antMatchers(&quot;&#x2F;dba&#x2F;**&quot;).hasRole(&quot;dba&quot;)</span><br><span class="line">	.antMatchers(&quot;&#x2F;user&#x2F;**&quot;).hasRole(&quot;user&quot;)</span><br><span class="line">	.anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginProcessingUrl(&quot;&#x2F;login&quot;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf()</span><br><span class="line">                .disable();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="高级配置"><a href="#高级配置" class="headerlink" title="高级配置"></a>高级配置</h1><p>动态配置权限<br>&nbsp;&nbsp;使用HttpSecurity配置的认证授权规则还是不够灵活,无法实现资源和角色之间的动态调整,要实现动态配置URL权限,就需要开发者自定义权限配置,配置步骤如下<br>1.数据库设计<br>&nbsp;&nbsp;在之前的基础上再增加一张资源表和资源角色关联表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">menu(资源表):主键 id int(11),pattern String</span><br><span class="line">menu_role(资源角色关联表):主键 id int(11),mid int(11),rid int(11)</span><br></pre></td></tr></table></figure>
<p>2.自定义FilterInvocationSecurityMetadataSource<br>&nbsp;&nbsp;要实现动态配置权限,首先要自定义FilterInvocationSecurityMetadataSource,Spring Security中通过FilterInvocationSecurityMetadataSource接口中的getAttribute方法来确定一个请求需要哪些角色,FilterInvocationSecurityMetadataSource接口的默认实现类是DefaultFilterInvocationSecurityMetadataSource,参考DefaultFilterInvocationSecurityMetadataSource的实现,开发者可以自定义自己的FilterInvocationSecurityMetadataSource,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class CustomFilterInvocationSecurityMetadataSource</span><br><span class="line">        implements FilterInvocationSecurityMetadataSource &#123;</span><br><span class="line">    AntPathMatcher antPathMatcher &#x3D; new AntPathMatcher();</span><br><span class="line">    @Resource</span><br><span class="line">    MenuMapper menuMapper;</span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;ConfigAttribute&gt; getAttributes(Object o) throws IllegalArgumentException &#123;</span><br><span class="line">        String requestUrl &#x3D; ((FilterInvocation) o).getRequestUrl();</span><br><span class="line">        List&lt;Menu&gt; allMenus &#x3D; menuMapper.getAllMenus();</span><br><span class="line">        for (Menu menu : allMenus)&#123;</span><br><span class="line">            if(antPathMatcher.match(menu.getPattern(),requestUrl))&#123;</span><br><span class="line">                List&lt;Role&gt; roles &#x3D; menu.getRoles();</span><br><span class="line">                String[] roleArr &#x3D; new String[roles.size()];</span><br><span class="line">                for(int i &#x3D;0;i&lt;roleArr.length;i++)&#123;</span><br><span class="line">                    roleArr[i] &#x3D; roles.get(i).getName();</span><br><span class="line">                &#125;</span><br><span class="line">                return SecurityConfig.createList(roleArr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return SecurityConfig.createList(&quot;ROLE_LOGIN&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Collection&lt;ConfigAttribute&gt; getAllConfigAttributes() &#123;return null;&#125;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean supports(Class&lt;?&gt; aClass) &#123;return FilterInvocation.class.isAssignableFrom(aClass);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码解释:<br>•开发者自定义FilterInvocationSecurityMetadataSource主要实现该接口中的getAttribute方法,该方法的参数是一个FilterInvocation,开发者可以从FilerInvocation中提取出当前请求的URL,返回值是Collection<ConfigAttribute>,表示当前请求URL所需的角色.<br>•第4行创建一个AntPathMatcher,主要用来实现ant风格的URL匹配.<br>•第9行从参数中提取出当前请求的URL.<br>•第10行从数据库中获取所有的资源信息,即本案例中的menu表以及menu所对应的role,在真实项目环境中,开发者可以将资源信息缓存在Redis或其他缓存数据库中.<br>•第11~20行遍历资源信息,遍历过程中获取当前请求的URL所需的角色信息并返回.如果当前请求的URL在资源表中不存在相应的模式,就假设该请求登录后即可访问,即直接返回ROLE_LOGIN.<br>•getAllConfigAttributes方法用来返回所有定义好的权限资源,SpringSecurity在启动是会校验相关配置是否正确,如果不需要校验,那么该方法直接返回null即可.<br>•supports方法返回类对象是否支持校验<br>3.自定义AccessDecisionManager<br>&nbsp;&nbsp;当一个请求走完FilterInvocationSecurityMetadataSource中的getAttribute方法后,接下来就会来到AccessDecisionManager类中进行角色信息的比对,自定义AccessDecisionManager如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class CustomAccessDecisionManager implements AccessDecisionManager &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void decide(Authentication auth, Object object, Collection&lt;ConfigAttribute&gt; ca) throws AccessDeniedException, InsufficientAuthenticationException &#123;</span><br><span class="line">        Collection&lt;? extends GrantedAuthority&gt; auths &#x3D; auth.getAuthorities();</span><br><span class="line">        for (ConfigAttribute configAttribute : ca)&#123;</span><br><span class="line">            if(&quot;ROLE_LOGIN&quot;.equals(configAttribute.getAttribute()) &amp;&amp; auth instanceof UsernamePasswordAuthenticationToken)&#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            for (GrantedAuthority authority : auths)&#123;</span><br><span class="line">                if(configAttribute.getAttribute().equals(authority.getAuthority()))&#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        throw new AccessDeniedException(&quot;权限不足&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean supports(ConfigAttribute configAttribute) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean supports(Class&lt;?&gt; aClass) &#123;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码解释:<br>•自定义AccessDecisionManager并重写decide方法,在该方法中判断当前登录的用户是否具备当前URL所需要的角色信息,如果不具备,就抛出AccessDeniedException异常,否则不做任何事即可.<br>•decide方法有三个参数,第一个参数包含当前登录用户的信息;第二个参数则是一个FilterInvocation对象,可以获取当前请求对象等;第三个参数就是FilterInvocationSecurityMetadataSource中的getAttribute方法的返回值,即当前请求URL所需要的角色.<br>•第5~15行进行角色信息比对,如果需要的角色是ROLE_LOGIN,说明当前请求的URL用户登录后即可访问,如果auth是UsernamePasswordAuthenticationToken的实例,那么说明当前用户已登录,该方法到此结束,否则进入正常的判断流程,如果当前用户具备当前请求需要的角色,那么方法结束.</p>
<p>&nbsp;&nbsp;本案例还涉及MenuMapper和MenuMapper.xml,实现如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Mapper</span><br><span class="line">public interface MenuMapper &#123;</span><br><span class="line">    List&lt;Menu&gt; getAllMenus();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Mapper 3.0&#x2F;&#x2F;EN&quot;</span><br><span class="line">        &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-mapper.dtd&quot;&gt;</span><br><span class="line">&lt;mapper namespace&#x3D;&quot;cn.pro.mapper.MenuMapper&quot;&gt;</span><br><span class="line">&lt;select id&#x3D;&quot;getAllMenus&quot; resultMap&#x3D;&quot;BaseResultMap&quot;&gt;</span><br><span class="line">    SELECT m.*,r.id as rid,r.name AS rname, r .nameZh AS rnameZh</span><br><span class="line">    FROM menu m LEFT JOIN menu_role mr ON m.id&#x3D;mr.rid LEFT JOIN role r ON mr.rid&#x3D;r.id</span><br><span class="line">&lt;&#x2F;select&gt;</span><br><span class="line">&lt;resultMap id&#x3D;&quot;BaseResultMap&quot; type&#x3D;&quot;Menu&quot;&gt;</span><br><span class="line">    &lt;id property&#x3D;&quot;id&quot; column&#x3D;&quot;id&quot;&#x2F;&gt;</span><br><span class="line">    &lt;result property&#x3D;&quot;pattern&quot; column&#x3D;&quot;pattern&quot;&#x2F;&gt;</span><br><span class="line">    &lt;collection property&#x3D;&quot;roles&quot; ofType&#x3D;&quot;Role&quot;&gt;</span><br><span class="line">        &lt;id property&#x3D;&quot;id&quot; column&#x3D;&quot;rid&quot;&#x2F;&gt;</span><br><span class="line">        &lt;result property&#x3D;&quot;name&quot; column&#x3D;&quot;rname&quot;&#x2F;&gt;</span><br><span class="line">        &lt;result property&#x3D;&quot;nameZh&quot; column&#x3D;&quot;rnameZh&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;collection&gt;</span><br><span class="line">&lt;&#x2F;resultMap&gt;</span><br><span class="line">&lt;&#x2F;mapper&gt;</span><br></pre></td></tr></table></figure>
<p>4.配置<br>&nbsp;&nbsp;最后,在SpringSecurity中配置如上两个自定义类,部分源码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class MyWebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">@Override</span><br><span class="line">    protected void configure(HttpSecurity http)throws Exception&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .withObjectPostProcessor(new ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public &lt;O extends FilterSecurityInterceptor&gt; O postProcess(O o) &#123;</span><br><span class="line">                        o.setSecurityMetadataSource(cfms());</span><br><span class="line">                        o.setAccessDecisionManager(cadm());</span><br><span class="line">                        return o;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginProcessingUrl(&quot;&#x2F;login&quot;)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf()</span><br><span class="line">                .disable();</span><br><span class="line">    &#125;</span><br><span class="line">    @Bean</span><br><span class="line">    CustomFilterInvocationSecurityMetadataSource cfms()&#123;</span><br><span class="line">        return new CustomFilterInvocationSecurityMetadataSource();</span><br><span class="line">    &#125;</span><br><span class="line">    @Bean</span><br><span class="line">    CustomAccessDecisionManager cadm()&#123;</span><br><span class="line">        return new CustomAccessDecisionManager();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码解释:<br>•本案例WebSecurityConfig类的定义是对之前WebSecurityConfig定义的补充,主要是修改了configure(HttpSecurity http)方法的实现并添加了两个Bean.<br>•第9、10行,在定义FilteSecurityInterceptor时,将我们自定义的两个实例设置进去即可.</p>
<h1 id="OAuth2"><a href="#OAuth2" class="headerlink" title="OAuth2"></a>OAuth2</h1><h2 id="OAuth2角色"><a href="#OAuth2角色" class="headerlink" title="OAuth2角色"></a>OAuth2角色</h2><p>&nbsp;&nbsp;要了解OAuth2,需要先了解OAuth2中几个基本的角色.<br>•资源所有者:资源所有者即用户,具有头像、照片、视频等资源.<br>•客户端:客户端即第三方应用,例如QQ授权登录的应用.<br>•授权服务器:授权服务器用来验证用户提供的信息是否正确,并返回一个令牌给第三方应用.<br>•资源服务器:资源服务器时提供给用户资源的服务器,例如头像、照片、视频等.<br>一般来说,授权服务器和资源服务器可以时同一台服务器.</p>
<p>##OAuth2授权流程<br>1.客户端(第三方应用)向用户请求授权.<br>2.用户单机客户端所呈现的服务授权页面上的同意授权按钮后,服务器返回一个授权许可凭证给客户端.<br>3.客户端拿着授权许可凭证去授权服务器申请令牌.<br>4.授权服务器验证信息无误后,发放令牌给客户端.<br>5.客户端拿着令牌去资源服务器访问资源.<br>6.资源服务器验证令牌无误后开放资源.</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>1.创建项目,添加依赖<br>&amp;nbsp&nbsp;创建Spring Boot Web项目,添加如下依赖:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;exclusions&gt;</span><br><span class="line">                &lt;exclusion&gt;</span><br><span class="line">                    &lt;groupId&gt;io.lettuce&lt;&#x2F;groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;lettuce-core&lt;&#x2F;artifactId&gt;</span><br><span class="line">                &lt;&#x2F;exclusion&gt;</span><br><span class="line">            &lt;&#x2F;exclusions&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;redis.clients&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jedis&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.security.oauth&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-security-oauth2&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.3.3.RELEASE&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;项目创建成功后,接下来在application.yml中配置以下Redis服务器的连接信息,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    database: 0</span><br><span class="line">    host: 127.0.0.1</span><br><span class="line">    port: 6379</span><br><span class="line">    password: 123456</span><br><span class="line">    jedis:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 8</span><br><span class="line">        max-idle: 8</span><br><span class="line">        max-wait: -1ms</span><br><span class="line">        min-idle: 0</span><br></pre></td></tr></table></figure>
<p>2.配置授权服务器<br>&nbsp;&nbsp;授权服务器和资源服务器可以是同一台服务器,也可以是不同服务器,本案例中假设是同一台服务器,通过不同的配置分别开启授权服务器和资源服务器,首先是授权服务器:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableAuthorizationServer</span><br><span class="line">public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter &#123;</span><br><span class="line">    @Resource</span><br><span class="line">    AuthenticationManager authenticationManager;&#x2F;&#x2F;注入了AuthenticationManager,该对象将用来支持password模式.</span><br><span class="line">    @Autowired</span><br><span class="line">    RedisConnectionFactory redisConnectionFactory;&#x2F;&#x2F;注入了RedisConnectionFactory,该对象将用来完成Redis缓存,将令牌信息存储到Redis缓存中.</span><br><span class="line">    @Autowired</span><br><span class="line">    UserDetailsService userDetailsService;&#x2F;&#x2F;注入了UserDetailsService,该对象将为刷新token提供支持.</span><br><span class="line">    @Bean</span><br><span class="line">    PasswordEncoder passwordEncoder()&#123;</span><br><span class="line">        return new BCryptPasswordEncoder();&#x2F;&#x2F;密码的配置,不再赘述.</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(ClientDetailsServiceConfigurer clients)throws Exception&#123;</span><br><span class="line">        clients.inMemory()</span><br><span class="line">                .withClient(&quot;password&quot;)</span><br><span class="line">                .authorizedGrantTypes(&quot;password&quot;,&quot;refresh_token&quot;)&#x2F;&#x2F;表示OAuth2中的授权模式为&quot;password&quot;和&quot;refresh_token&quot;两种,在标准的OAuth2协议中,授权模式并不包括&quot;refresh_token&quot;</span><br><span class="line">                .accessTokenValiditySeconds(1800)&#x2F;&#x2F;设置access_token的过期时间</span><br><span class="line">                .resourceIds(&quot;ids&quot;)&#x2F;&#x2F;配置了资源id</span><br><span class="line">                .scopes(&quot;all&quot;)</span><br><span class="line">                .secret(&quot;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&quot;);&#x2F;&#x2F;配置加密后的密码,明文是123</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(AuthorizationServerEndpointsConfigurer endpoints)throws Exception&#123;</span><br><span class="line">        endpoints.tokenStore(new RedisTokenStore(redisConnectionFactory))</span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                .userDetailsService(userDetailsService);&#x2F;&#x2F;authenticationManager和userDetailsService主要用于支持password模式以及令牌的刷新.</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(AuthorizationServerSecurityConfigurer security)throws Exception&#123;</span><br><span class="line">        security.allowFormAuthenticationForClients();&#x2F;&#x2F;表示支持client_id和client_secret做登录认证.</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.配置资源服务器<br>&nbsp;&nbsp;接下来配置资源服务器,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@EnableResourceServer</span><br><span class="line">public class ResourceServerConfig extends ResourceServerConfigurerAdapter &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(ResourceServerSecurityConfigurer resources)throws Exception&#123;</span><br><span class="line">        resources.resourceId(&quot;ids&quot;).stateless(true);&#x2F;&#x2F;这里的资源id和授权服务器中的资源id一致,然后设置这些资源仅基于令牌认证</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public void configure(HttpSecurity http)throws Exception&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .antMatchers(&quot;&#x2F;admin&#x2F;**&quot;).hasRole(&quot;admin&quot;)</span><br><span class="line">                .antMatchers(&quot;&#x2F;user&#x2F;**&quot;).hasRole(&quot;user&quot;)</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.配置Security<br>&nbsp;&nbsp;接下来配置SpringSecurity,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class WebSecurityConfig extends WebSecurityConfigurerAdapter &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    @Override</span><br><span class="line">    public AuthenticationManager authenticationManagerBean()throws Exception&#123;</span><br><span class="line">        return super.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">    @Bean</span><br><span class="line">    @Override</span><br><span class="line">    protected UserDetailsService userDetailsService()&#123;</span><br><span class="line">        return super.userDetailsService();</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(AuthenticationManagerBuilder auth)throws Exception&#123;</span><br><span class="line">        auth.inMemoryAuthentication()</span><br><span class="line">                .withUser(&quot;admin&quot;)</span><br><span class="line">                .password(&quot;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&quot;)</span><br><span class="line">                .roles(&quot;admin&quot;)</span><br><span class="line">                .and()</span><br><span class="line">                .withUser(&quot;sang&quot;)</span><br><span class="line">                .password(&quot;$2a$10$RMuFXGQ5AtH4wOvkUqyvuecpqUSeoxZYqilXzbz50dceRsga.WYiq&quot;)</span><br><span class="line">                .roles(&quot;user&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    protected void configure(HttpSecurity http)throws Exception&#123;</span><br><span class="line">        http.antMatcher(&quot;&#x2F;oauth&#x2F;**&quot;).authorizeRequests()</span><br><span class="line">                .antMatchers(&quot;&#x2F;oauth&#x2F;**&quot;).permitAll()</span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.测试验证<br>&nbsp;&nbsp;首先创建三个简单的请求地址,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class HelloController &#123;</span><br><span class="line">    @GetMapping(&quot;&#x2F;admin&#x2F;hello&quot;)</span><br><span class="line">    public String admin()&#123;</span><br><span class="line">        return &quot;Hello admin!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    @GetMapping(&quot;&#x2F;user&#x2F;hello&quot;)</span><br><span class="line">    public String user()&#123;</span><br><span class="line">        return &quot;Hello user!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    @GetMapping(&quot;&#x2F;hello&quot;)</span><br><span class="line">    public String hello()&#123;</span><br><span class="line">        return &quot;Hello!&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;根据前文的配置,要请求这三个地址,分别需要admin角色、user角色以及登陆后访问.<br>&nbsp;&nbsp;所有都配置完成后,启动Redis服务器,再启动SpringBoot项目,首先发送一个Post请求获取token,请求地址如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;oauth&#x2F;token?username&#x3D;admin&amp;password&#x3D;123&amp;grant_type&#x3D;password&amp;client_id&#x3D;password&amp;scope&#x3D;all&amp;client_secret&#x3D;123</span><br></pre></td></tr></table></figure>
<p>请求地址中包含的参数有用户名、密码、授权模式、客户端id、scope以及客户端密码,基本就是授权服务器中所配置的数据.返回如下结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;access_token&quot;: &quot;e5287655-8643-4376-8147-3427b772667d&quot;,</span><br><span class="line">    &quot;token_type&quot;: &quot;bearer&quot;,</span><br><span class="line">    &quot;refresh_token&quot;: &quot;56db9398-621a-4550-8b72-f9e95a64236f&quot;,</span><br><span class="line">    &quot;expires_in&quot;: 1799,</span><br><span class="line">    &quot;scope&quot;: &quot;all&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;返回结果有access_token、token_type、refresh_token、expires_in以及scope,其中access_token是获取其他资源时要用的令牌,refresh_token用来刷新令牌,expires_in表示acess_token的过期时间,当access_token过期后,使用refresh_token重新获取新的access_token(前提时refresh_token未过期),请求地址如下(注意这里也是POST请求):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;oauth&#x2F;token?grant_type&#x3D;refresh_token&amp;refresh_token&#x3D;56db9398-621a-4550-8b72-f9e95a64236f&amp;client_id&#x3D;password&amp;client_secret&#x3D;123</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;接下来访问所有资源,携带上access_token参数即可,例如”/user.hello”接口:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost:8080&#x2F;user&#x2F;hello?access_token&#x3D;e5287655-8643-4376-8147-3427b772667d</span><br></pre></td></tr></table></figure>
<center>综上,OAuth2基本配置与用法讲述完毕</center>

<h1 id="SpringBoot整合Shiro"><a href="#SpringBoot整合Shiro" class="headerlink" title="SpringBoot整合Shiro"></a>SpringBoot整合Shiro</h1><p>1.创建项目<br>&nbsp;&nbsp;老样子,创项目,导依赖.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.theborakompanioni&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;thymeleaf-extras-shiro&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.shiro&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;shiro-spring-boot-web-starter&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>2.Shiro基本配置<br>&nbsp;&nbsp;首先再application.yml中配置Shiro的基本信息,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">shiro:</span><br><span class="line">  enabled: true &#x2F;&#x2F;开启Shiro配置,默认为true.</span><br><span class="line">  web:</span><br><span class="line">    enabled: true &#x2F;&#x2F;开启ShiroWeb配置,默认为true</span><br><span class="line">  loginUrl: &#x2F;login &#x2F;&#x2F;表示登录地址,默认为&quot;&#x2F;login.jsp&quot;</span><br><span class="line">  successUrl: &#x2F;index &#x2F;&#x2F;表示登录成功地址,默认为&quot;&#x2F;&quot;.</span><br><span class="line">  unauthorizedUrl: &#x2F;unauthorized &#x2F;&#x2F;表示未获授权默认跳转地址</span><br><span class="line">  sessionManager:</span><br><span class="line">    sessionIdUrlRewritingEnabled: true &#x2F;&#x2F;表示是否允许通过URL参数实现会话跟踪,如果网站支持Cookie,可以关闭此选项,默认为true.</span><br><span class="line">    sessionIdCookieEnabled: true &#x2F;&#x2F;表示是否允许通过Cookie实现会话跟踪,默认为true.</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;基本信息配置完成后,接下来再Java代码中配置Shiro,提供两个最基本的Bean即可,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class ShiroConfig &#123;</span><br><span class="line">    @Bean</span><br><span class="line">    public Realm realm()&#123;</span><br><span class="line"></span><br><span class="line">        TextConfigurationRealm realm &#x3D; new TextConfigurationRealm();</span><br><span class="line">        realm.setUserDefinitions(&quot;sang&#x3D;123,user\n admin&#x3D;123,admin&quot;);</span><br><span class="line">        realm.setRoleDefinitions(&quot;admin&#x3D;read,write\n user&#x3D;read&quot;);</span><br><span class="line">        return realm;</span><br><span class="line">    &#125;</span><br><span class="line">    @Bean</span><br><span class="line">    public ShiroFilterChainDefinition shiroFilterChainDefinition()&#123;</span><br><span class="line">        DefaultShiroFilterChainDefinition chainDefinition &#x3D; new DefaultShiroFilterChainDefinition();</span><br><span class="line">        chainDefinition.addPathDefinition(&quot;&#x2F;login&quot;,&quot;anon&quot;);</span><br><span class="line">        chainDefinition.addPathDefinition(&quot;&#x2F;doLogin&quot;,&quot;anon&quot;);</span><br><span class="line">        chainDefinition.addPathDefinition(&quot;&#x2F;logout&quot;,&quot;logout&quot;);</span><br><span class="line">        chainDefinition.addPathDefinition(&quot;&#x2F;**&quot;,&quot;authc&quot;);</span><br><span class="line">        return chainDefinition;</span><br><span class="line">    &#125;</span><br><span class="line">    @Bean</span><br><span class="line">    public ShiroDialect shiroDialect()&#123;</span><br><span class="line">        return new ShiroDialect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码解释:<br>•这里提供两个关键Bean,一个是Realm,另一个是ShiroFilterChainDefinition.至于ShiroDialect,则是为了支持再Thymeleaf中使用Shiro标签,如果不在Thymeleaf中使用Shiro标签,那么可以不提供ShiroDialect.<br>•Realm可以是自定义Realm,也可以是Shiro提供的Realm,简单起见,本案例没有配置数据库连接,这里直接配置了两个用户:sang/123和admin/123,分别对应角色user和admin,user具有read权限,admin则具有read、write权限.<br>•ShiroFilterChainDefinition Bean中配置了基本的过滤规则,”/login”和”/doLogin”可以匿名访问,”/login”是一个注销登录请求,其余请求则都需要认证后才能访问.<br>&nbsp;&nbsp;接下来配置登录接口以及页面访问接口,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">public class UserController &#123;</span><br><span class="line">    @PostMapping(&quot;&#x2F;doLogin&quot;)</span><br><span class="line">    public String doLogin(String username, String password, Model model)&#123;</span><br><span class="line">        UsernamePasswordToken token &#x3D; new UsernamePasswordToken(username,password);</span><br><span class="line">        Subject subject &#x3D; SecurityUtils.getSubject();</span><br><span class="line">        try &#123;</span><br><span class="line">            subject.login(token);</span><br><span class="line">        &#125;catch (AuthenticationException e)&#123;</span><br><span class="line">            model.addAttribute(&quot;error&quot;,&quot;用户名或密码输出错误!&quot;);</span><br><span class="line">            return &quot;login&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;redirect:&#x2F;index&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequiresRoles(value &#x3D; &quot;admin&quot;)</span><br><span class="line">    @GetMapping(&quot;&#x2F;admin&quot;)</span><br><span class="line">    public String admin()&#123;</span><br><span class="line">        return &quot;damin&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequiresRoles(value &#x3D; &#123;&quot;admin&quot;,&quot;user&quot;&#125;,logical &#x3D; Logical.OR)</span><br><span class="line">    @GetMapping(&quot;&#x2F;user&quot;)</span><br><span class="line">    public String user()&#123;</span><br><span class="line">        return &quot;suer&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;<br>对于其他不需要角色就能访问的接口,直接在WebMvc中配置即可,代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class WebMvcConfig implements WebMvcConfigurer &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void addViewControllers(ViewControllerRegistry registry)&#123;</span><br><span class="line">        registry.addViewController(&quot;&#x2F;login&quot;).setViewName(&quot;login&quot;);</span><br><span class="line">        registry.addViewController(&quot;&#x2F;index&quot;).setViewName(&quot;index&quot;);</span><br><span class="line">        registry.addViewController(&quot;&#x2F;unauthorized&quot;).setViewName(&quot;unauthorized&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;全局异常处理代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@ControllerAdvice</span><br><span class="line">public class ExceptionController&#123;</span><br><span class="line">    @ExceptionHandler(AuthorizationException.class)</span><br><span class="line">    public ModelAndView error(AuthorizationException e)&#123;</span><br><span class="line">        ModelAndView mv &#x3D; new ModelAndView();</span><br><span class="line">        mv.addObject(&quot;error&quot;,e.getMessage());</span><br><span class="line">        return mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;当用户访问未授权的资源时,跳转到unauthorized视图中,并携带出错信息.<br>&nbsp;&nbsp;配置完成后,最后在resources/templates目录下创建5个HTML页面进行测试.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--index.html--&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot; xmlns:shiro&#x3D;&quot;http:&#x2F;&#x2F;www.pollix.at&#x2F;thymeleaf&#x2F;shiro&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h3&gt;Hello,&lt;shiro:principal&#x2F;&gt;&lt;&#x2F;h3&gt;</span><br><span class="line">&lt;h3&gt;&lt;a href&#x3D;&quot;&#x2F;logout&quot;&gt;注销登录&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;</span><br><span class="line">&lt;h3&gt;&lt;a shiro:hasRole&#x3D;&quot;admin&quot; href&#x3D;&quot;&#x2F;admin&quot;&gt;管理员页面&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;</span><br><span class="line">&lt;h3&gt;&lt;a shiro:hasAnyRoles&#x3D;&quot;admin,user&quot; href&#x3D;&quot;&#x2F;user&quot;&gt;普通用户页面&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--login.html--&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot; xmlns:th&#x3D;&quot;http:&#x2F;&#x2F;www.thymeleaf.org&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;form action&#x3D;&quot;&#x2F;doLogin&quot; method&#x3D;&quot;post&quot;&gt;</span><br><span class="line">    用户名&lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;username&quot;&gt;&lt;br&gt;</span><br><span class="line">    密码&lt;input type&#x3D;&quot;password&quot; name&#x3D;&quot;password&quot;&gt;&lt;br&gt;</span><br><span class="line">    &lt;div th:text&#x3D;&quot;$&#123;error&#125;&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;登录&quot;&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--user.html--&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;普通用户页面&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--admin.html--&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;管理员页面&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--unauthorized.html--&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot; xmlns:th&#x3D;&quot;http:&#x2F;&#x2F;http:&#x2F;&#x2F;www.thymeleaf.org&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;h3&gt;未获授权,非法访问&lt;&#x2F;h3&gt;</span><br><span class="line">    &lt;h3 th:text&#x3D;&quot;$&#123;error&#125;&quot;&gt;&lt;&#x2F;h3&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>
<p>3.测试<br>&nbsp;&nbsp;配置完成后,启动SpringBoot项目,访问登录页面,分别使用sang/123和admin/123登录。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AE%89%E5%85%A8/" rel="tag"># 安全</a>
              <a href="/tags/%E5%8A%A0%E5%AF%86/" rel="tag"># 加密</a>
              <a href="/tags/%E7%99%BB%E5%BD%95/" rel="tag"># 登录</a>
              <a href="/tags/%E6%B3%A8%E9%94%80/" rel="tag"># 注销</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/07/17/SpringBoot%E8%BF%9B%E9%98%B6/" rel="prev" title="SpringBoot进阶">
      <i class="fa fa-chevron-left"></i> SpringBoot进阶
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/08/06/AMQP/" rel="next" title="AMQP">
      AMQP <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#基本用法"><span class="nav-number">1.</span> <span class="nav-text">基本用法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置用户名和密码"><span class="nav-number">2.</span> <span class="nav-text">配置用户名和密码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#基于内存的认证"><span class="nav-number">3.</span> <span class="nav-text">基于内存的认证</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HttpSecurity"><span class="nav-number">4.</span> <span class="nav-text">HttpSecurity</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#登录表单详细配置"><span class="nav-number">5.</span> <span class="nav-text">登录表单详细配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#注销登录配置"><span class="nav-number">6.</span> <span class="nav-text">注销登录配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#密码加密"><span class="nav-number">7.</span> <span class="nav-text">密码加密</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#基于数据库的认证"><span class="nav-number">8.</span> <span class="nav-text">基于数据库的认证</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#高级配置"><span class="nav-number">9.</span> <span class="nav-text">高级配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#OAuth2"><span class="nav-number">10.</span> <span class="nav-text">OAuth2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OAuth2角色"><span class="nav-number">10.1.</span> <span class="nav-text">OAuth2角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实践"><span class="nav-number">10.2.</span> <span class="nav-text">实践</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringBoot整合Shiro"><span class="nav-number">11.</span> <span class="nav-text">SpringBoot整合Shiro</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description">平时小笔记，记录别人美好代码</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://baidu.com/" title="百度 → https:&#x2F;&#x2F;baidu.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-firefox"></i>百度</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='1,145,14' opacity='1' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script size="300" alpha="0.6" zIndex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":300,"height":750},"mobile":{"show":false},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false});</script></body>
</html>
